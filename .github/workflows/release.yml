name: Manual Release

on:
  workflow_dispatch:
    inputs:
      release_notes_en:
        description: 'Release notes (English)'
        required: false
        type: string
      release_notes_ja:
        description: 'ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ (æ—¥æœ¬èª)'
        required: false
        type: string
      dry_run:
        description: 'Actually create a release? (ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ã¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã®ã¿è¡Œã„ã¾ã™)'
        required: true
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆã‚¿ã‚°ã®å·®åˆ†è¨ˆç®—ã«å¿…è¦ï¼‰

      - name: set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      # 1. ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®å–å¾—
      - name: Extract Version Info
        id: version_info
        run: |
          VERSION_CODE=$(grep "versionCode" app/build.gradle | awk '{print $2}')
          VERSION_NAME=$(grep "versionName" app/build.gradle | sed 's/.*"\(.*\)".*/\1/')

          # stationVerã®æŠ½å‡º (ä¾‹: 'v20251221' -> '20251221')
          STATION_VER_RAW=$(grep "def stationVer =" app/build.gradle | sed "s/.*'\(.*\)'.*/\1/")
          STATION_VER=${STATION_VER_RAW#v}
          TAG_NAME="v${VERSION_NAME}_${STATION_VER}"

          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "station_ver=$STATION_VER" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

          echo "Detected: $TAG_NAME (Code: $VERSION_CODE)"

      # 2. ãƒãƒ¼ã‚¸ãƒ§ãƒ³é‡è¤‡ãƒã‚§ãƒƒã‚¯
      - name: Check for Existing Release
        if: github.event.inputs.dry_run == 'true'
        run: |
          TAG_NAME="${{ steps.version_info.outputs.tag_name }}"

          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "::error::Tag '$TAG_NAME' already exists. Please update versionName or stationVer in build.gradle."
            exit 1
          fi
          echo "Version check passed. '$TAG_NAME' is a new tag."

      # 3. ãƒã‚§ãƒ³ã‚¸ãƒ­ã‚°ã®æ±ºå®š
      - name: Prepare Changelogs
        id: changelog
        run: |
          INPUT_EN="${{ github.event.inputs.release_notes_en }}"
          INPUT_JA="${{ github.event.inputs.release_notes_ja }}"
          VER="${{ steps.version_info.outputs.station_ver }}"

          # å…±é€šã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨Gitãƒ­ã‚°ç”Ÿæˆ
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || git rev-list --max-parents=0 HEAD)
          GIT_LOG=$(git log $PREV_TAG..HEAD --pretty=format:"* %s" --no-merges)
          [ -z "$GIT_LOG" ] && GIT_LOG="No changes since last release."

          # è‹±èªç‰ˆã®æ±ºå®š
          if [ -n "$INPUT_EN" ]; then
            CHANGES_EN="$INPUT_EN"
          else
            CHANGES_EN="$GIT_LOG"
          fi
          # ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¿½è¨˜ (English)
          CHANGES_EN="${CHANGES_EN}"$'\n\n'"Data Version : v${VER}"

          # æ—¥æœ¬èªç‰ˆã®æ±ºå®š
          if [ -n "$INPUT_JA" ]; then
            CHANGES_JA="$INPUT_JA"
          else
            CHANGES_JA="$GIT_LOG"
          fi
          # ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¿½è¨˜ (Japanese)
          CHANGES_JA="${CHANGES_JA}"$'\n\n'"ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³ : v${VER}"

          # GitHub Actionsã®å‡ºåŠ›ç”¨ï¼ˆãƒãƒ«ãƒãƒ©ã‚¤ãƒ³å¯¾å¿œï¼‰
          echo "en<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGES_EN" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "ja<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGES_JA" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 4. Fastlaneã®ãƒã‚§ãƒ³ã‚¸ãƒ­ã‚°ã‚’ã‹ãåˆ†ã‘
      - name: Update Fastlane Changelogs
        run: |
          CODE="${{ steps.version_info.outputs.version_code }}"

          mkdir -p fastlane/metadata/android/en-US/changelogs/
          mkdir -p fastlane/metadata/android/ja-JP/changelogs/

          echo "${{ steps.changelog.outputs.en }}" > "fastlane/metadata/android/en-US/changelogs/${CODE}.txt"
          echo "${{ steps.changelog.outputs.ja }}" > "fastlane/metadata/android/ja-JP/changelogs/${CODE}.txt"

          echo "Fastlane changelog files updated for both en-US and ja-JP."

      # 5. ç”Ÿæˆã—ãŸãƒã‚§ãƒ³ã‚¸ãƒ­ã‚°ã‚’ãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆ (æœ¬ç•ªå®Ÿè¡Œæ™‚ã®ã¿)
      - name: Commit Changelogs
        if: github.event.inputs.dry_run == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add fastlane/metadata/android/*/changelogs/*.txt
          git commit -m "chore: update fastlane changelogs for ${{ steps.version_info.outputs.tag_name }}" || echo "No changes to commit"
          git push origin main

      # 6. Keystoreã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (SecretsãŒã‚ã‚‹å ´åˆã®ã¿)
      - name: Setup Keystore
        if: ${{ secrets.SIGNING_KEY_STORE_BASE64 != '' }}
        run: |
          echo "${{ secrets.SIGNING_KEY_STORE_BASE64 }}" | base64 -d > app/release-key.jks
          echo "Keystore file restored."

      # 7. APKã®ãƒ“ãƒ«ãƒ‰ (ç½²åä»˜ã)
      - name: Build Release APK
        env:
          # SecretsãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¨­å®š
          SIGNING_STORE_FILE: ${{ secrets.SIGNING_KEY_STORE_BASE64 != '' && 'release-key.jks' || '' }}
          SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
          SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
        run: ./gradlew assembleRelease

      # 8. GitHub Release ã®ä½œæˆã¨APKæ·»ä»˜ (æœ¬ç•ªå®Ÿè¡Œæ™‚ã®ã¿)
      - name: Create GitHub Release
        if: github.event.inputs.dry_run == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version_info.outputs.tag_name }}
          name: ${{ steps.version_info.outputs.tag_name }}
          body: |
            ## å¤‰æ›´ç‚¹ (æ—¥æœ¬èª)
            ${{ steps.changelog.outputs.ja }}
          files: |
            app/build/outputs/apk/release/*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (å®Ÿéš›ã«è¨­å®šã•ã‚Œã‚‹æƒ…å ±ã‚’ã™ã¹ã¦è¡¨ç¤º)
      - name: Dry Run Summary
        if: github.event.inputs.dry_run == 'false'
        run: |
          echo "### Dry Run Completed Successfully! ğŸš€" >> $GITHUB_STEP_SUMMARY
          echo "#### ğŸ“¦ Release Metadata" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag Name:** \`${{ steps.version_info.outputs.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Name:** \`${{ steps.version_info.outputs.tag_name }}\`" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ğŸ“ Final Release Body (Draft):" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`markdown" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## å¤‰æ›´ç‚¹ (æ—¥æœ¬èª)" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.changelog.outputs.ja }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ğŸ“‚ Artifacts to be Attached (APK):" >> $GITHUB_STEP_SUMMARY
          # ç”Ÿæˆã•ã‚ŒãŸå®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—
          ls -1 app/build/outputs/apk/release/*.apk | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "- (No APK files found - check build logs)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** This was a dry run. If it were a real run, the above information would be used to create a GitHub Release and update the repository." >> $GITHUB_STEP_SUMMARY
